name: Update Profile README (Activity & Quote)

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 00:00 è¿è¡Œ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq ca-certificates

      - name: Build activity summary
        id: build_summaries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          REPOS=("Jarv1s0/RouteX" "Jarv1s0/Proxy_Script")
          ACTIVITY_MD=""

          for repo in "${REPOS[@]}"; do
            repo_name="${repo##*/}"

            # Get Latest Release Info
            release_resp=$(curl -sS -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token ${GITHUB_TOKEN}" \
              "https://api.github.com/repos/$repo/releases/latest" 2>/dev/null || echo "{}")
            
            release_tag=$(echo "$release_resp" | jq -r '.tag_name // empty' 2>/dev/null)
            release_url=$(echo "$release_resp" | jq -r '.html_url // empty' 2>/dev/null)
            
            if [ -n "$release_tag" ] && [ "$release_tag" != "null" ]; then
              release_info="ğŸš€ [${release_tag}](${release_url})"
            else
              release_info="ğŸŒ± No release"
            fi

            # Get Latest Commit
            commit_resp=$(curl -sS -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token ${GITHUB_TOKEN}" \
              "https://api.github.com/repos/$repo/commits?per_page=1" 2>/dev/null || echo "[]")
            
            commit_sha=$(echo "$commit_resp" | jq -r '.[0].sha // empty' 2>/dev/null | cut -c1-7)
            commit_msg=$(echo "$commit_resp" | jq -r '.[0].commit.message // empty' 2>/dev/null | head -n1 | sed 's/\\/\\\\/g; s/"/\\"/g')
            commit_url=$(echo "$commit_resp" | jq -r '.[0].html_url // empty' 2>/dev/null)
            
            if [ -n "$commit_msg" ] && [ "$commit_msg" != "null" ] && [ -n "$commit_url" ]; then
              sha_disp=""
              [ -n "$commit_sha" ] && sha_disp=" (\`${commit_sha}\`)"
              ACTIVITY_MD="${ACTIVITY_MD}- **${repo_name}** â€” ${release_info} Â· ğŸ“ [${commit_msg}](${commit_url})${sha_disp}"$'\n'
            fi
          done

          # Daily quote (Hitokoto for better CN support)
          quote=$(curl -sS "https://v1.hitokoto.cn/?c=i&c=k" 2>/dev/null | jq -r '.hitokoto + " â€” " + .from' 2>/dev/null || echo "ä¿æŒå¥½å¥‡ï¼ŒæŒç»­å­¦ä¹ ã€‚")

          {
            echo "activity<<EOF"
            echo "$ACTIVITY_MD"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          {
            echo "quote<<EOF"
            echo "$quote"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Replace README sections
        run: |
          set -e
          activity="${{ steps.build_summaries.outputs.activity }}"
          quote="${{ steps.build_summaries.outputs.quote }}"

          cat > README.md << 'EOF'
<p align="center">
  <img src="https://capsule-render.vercel.app/api?type=waving&color=auto&height=200&section=header&text=Hi,%20I'm%20Jarv1s0&fontSize=70&animation=fadeIn" />
</p>

> å®ç”¨å·¥å…·é›†åˆ

<p align="center">
  <img src="https://img.shields.io/github/followers/Jarv1s0?label=Follow&style=for-the-badge&logo=github&color=24292e" />
  <img src="https://komarev.com/ghpvc/?username=Jarv1s0&color=blue&style=for-the-badge&label=VIEWS" />
</p>

---

## ğŸ›  æŠ€æœ¯æ ˆ
<p align="left">
  <img src="https://img.shields.io/badge/TypeScript-3178C6?style=for-the-badge&logo=typescript&logoColor=white" />
  <img src="https://img.shields.io/badge/Electron-47848F?style=for-the-badge&logo=electron&logoColor=white" />
  <img src="https://img.shields.io/badge/Node.js-339933?style=for-the-badge&logo=nodedotjs&logoColor=white" />
  <img src="https://img.shields.io/badge/Vue.js-4FC08D?style=for-the-badge&logo=vuedotjs&logoColor=white" />
  <img src="https://img.shields.io/badge/Shell_Script-121011?style=for-the-badge&logo=gnu-bash&logoColor=white" />
</p>

---

## ğŸš€ ç²¾é€‰é¡¹ç›®

<table>
  <tr>
    <td width="50%" valign="top">
      <h3>RouteX</h3>
      <p>åŸºäº Electron + TypeScript çš„æ¡Œé¢å®¢æˆ·ç«¯ï¼Œä¸“æ³¨äº UI é‡æ„ä¸æ„å»ºä¼˜åŒ–ã€‚</p>
      <a href="https://github.com/Jarv1s0/RouteX">
        <img src="https://img.shields.io/github/stars/Jarv1s0/RouteX?style=flat-square&logo=github&color=yellow" />
      </a>
      <a href="https://github.com/Jarv1s0/RouteX/releases">
        <img src="https://img.shields.io/github/v/release/Jarv1s0/RouteX?style=flat-square&color=blue" />
      </a>
    </td>
    <td width="50%" valign="top">
      <h3>Proxy_Script</h3>
      <p>ç²¾é€‰ä»£ç†å®¢æˆ·ç«¯é…ç½® (Clash / QX / Loon) ä¸è‡ªåŠ¨åŒ–è„šæœ¬é›†åˆã€‚</p>
      <a href="https://github.com/Jarv1s0/Proxy_Script">
        <img src="https://img.shields.io/github/stars/Jarv1s0/Proxy_Script?style=flat-square&logo=github&color=yellow" />
      </a>
    </td>
  </tr>
</table>

---

## ğŸ•’ æœ€è¿‘åŠ¨æ€
EOF
          echo "$activity" >> README.md
          cat >> README.md << 'EOF'

## ğŸ’¬ æ¯æ—¥ä¸€å¥
> EOF
          echo "$quote" >> README.md
          cat >> README.md << 'EOF'

<p align="right">
  <i>æœ€åæ›´æ–°æ—¶é—´ï¼šè‡ªåŠ¨æ›´æ–°</i>
</p>
EOF

      - name: Commit and push
        uses: EndBug/add-and-commit@v9
        with:
          message: "chore: automated profile update"
          add: README.md
