name: Update Profile README (Activity & Quote)

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 00:00 è¿è¡Œ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq ca-certificates

      - name: Build activity summary
        id: build_summaries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          REPOS=("Jarv1s0/RouteX" "Jarv1s0/Proxy_Script")
          ACTIVITY_MD=""

          gh_api() {
            url="$1"
            http_code=$(curl -sS -w "%{http_code}" -o /tmp/resp.json \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token ${GITHUB_TOKEN}" \
              --fail --location --retry 3 --retry-delay 2 \
              "$url" ) || return 1
            cat /tmp/resp.json
          }

          for repo in "${REPOS[@]}"; do
            owner_repo="$repo"
            repo_name="${repo##*/}"

            # Get Latest Release Info
            if release_resp=$(gh_api "https://api.github.com/repos/$owner_repo/releases/latest"); then
              release_tag=$(echo "$release_resp" | jq -r '.tag_name // empty')
              release_url=$(echo "$release_resp" | jq -r '.html_url // empty')
              release_info="ğŸš€ [${release_tag}](${release_url})"
            else
              release_info="ğŸŒ± No release"
            fi

            # Get Latest Commit
            if commit_resp=$(gh_api "https://api.github.com/repos/$owner_repo/commits?per_page=1"); then
              commit_sha=$(echo "$commit_resp" | jq -r '.[0].sha // empty')
              if [ -n "$commit_sha" ]; then commit_sha="${commit_sha:0:7}"; fi
              commit_msg=$(echo "$commit_resp" | jq -r '.[0].commit.message' | head -n1 | sed 's/"/\\"/g' || echo "")
              commit_url=$(echo "$commit_resp" | jq -r '.[0].html_url // empty')
              sha_disp=""
              if [ -n "$commit_sha" ]; then sha_disp=" (\`${commit_sha}\`)"; fi
              ACTIVITY_MD="${ACTIVITY_MD}<li><b>${repo_name}</b> â€” ${release_info} Â· ğŸ“ <a href=\"${commit_url}\">${commit_msg}</a>${sha_disp}</li>\n"
            fi
          done

          # Daily quote (Hitokoto for better CN support)
          quote=$(curl -sS --fail "https://v1.hitokoto.cn/?c=i&c=k" | jq -r '.hitokoto + " â€” " + .from' 2>/dev/null || echo "ä¿æŒå¥½å¥‡ï¼ŒæŒç»­å­¦ä¹ ã€‚")

          echo "activity<<EOF" >> "$GITHUB_OUTPUT"
          printf "%s\n" "${ACTIVITY_MD}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          echo "quote<<EOF" >> "$GITHUB_OUTPUT"
          echo "${quote}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Replace README sections
        run: |
          set -euo pipefail
          activity=$(echo "${{ steps.build_summaries.outputs.activity }}" | sed 's/\\n/\n/g')
          quote="${{ steps.build_summaries.outputs.quote }}"

          cat > README.md <<EOF
<p align="center">
  <img src="https://capsule-render.vercel.app/api?type=waving&color=auto&height=200&section=header&text=Hi,%20I'm%20Jarv1s0&fontSize=70&animation=fadeIn" />
</p>
<p align="center">
  <img src="https://img.shields.io/github/followers/Jarv1s0?label=Follow&style=for-the-badge&logo=github&color=24292e" />
  <img src="https://komarev.com/ghpvc/?username=Jarv1s0&color=blue&style=for-the-badge&label=VIEWS" />
</p>

## ğŸš€ ç²¾é€‰é¡¹ç›®
<table>
  <tr>
    <td width="50%" valign="top">
      <h3>RouteX</h3>
      <p>åŸºäº Electron + TypeScript çš„æ¡Œé¢å®¢æˆ·ç«¯ï¼Œä¸“æ³¨äº UI é‡æ„ä¸æ„å»ºä¼˜åŒ–ã€‚</p>
      <a href="https://github.com/Jarv1s0/RouteX">
        <img src="https://img.shields.io/github/stars/Jarv1s0/RouteX?style=flat-square&logo=github&color=yellow" />
      </a>
      <a href="https://github.com/Jarv1s0/RouteX/releases">
        <img src="https://img.shields.io/github/v/release/Jarv1s0/RouteX?style=flat-square&color=blue" />
      </a>
    </td>
    <td width="50%" valign="top">
      <h3>Proxy_Script</h3>
      <p>ç²¾é€‰ä»£ç†å®¢æˆ·ç«¯é…ç½® (Clash / QX / Loon) ä¸è‡ªåŠ¨åŒ–è„šæœ¬é›†åˆã€‚</p>
      <a href="https://github.com/Jarv1s0/Proxy_Script">
        <img src="https://img.shields.io/github/stars/Jarv1s0/Proxy_Script?style=flat-square&logo=github&color=yellow" />
      </a>
    </td>
  </tr>
</table>

## ğŸ“Š ç»Ÿè®¡çœ‹æ¿
<p align="center">
  <img src="https://raw.githubusercontent.com/Jarv1s0/Jarv1s0/main/profile-summary-card-output/tokyonight/3-stats.svg" width="48%" />
  <img src="https://raw.githubusercontent.com/Jarv1s0/Jarv1s0/main/profile-summary-card-output/tokyonight/1-repos-per-language.svg" width="41%" />
</p>

## ğŸ•’ æœ€è¿‘åŠ¨æ€
<div align="left">
  <ul>
${activity}
  </ul>
</div>

## ğŸ’¬ æ¯æ—¥ä¸€å¥
<p align="center"><i>${quote}</i></p>
EOF

      - name: Commit and push
        uses: EndBug/add-and-commit@v9
        with:
          message: "chore: automated profile update"
          add: README.md
