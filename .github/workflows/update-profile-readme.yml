name: Update Profile README (Activity & Quote)

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 00:00 è¿è¡Œ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq ca-certificates

      - name: Build activity summary
        id: build_summaries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          REPOS=("Jarv1s0/RouteX" "Jarv1s0/Proxy_Script")
          ACTIVITY_MD=""

          gh_api() {
            url="$1"
            http_code=$(curl -sS -w "%{http_code}" -o /tmp/resp.json \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token ${GITHUB_TOKEN}" \
              --fail --location --retry 3 --retry-delay 2 \
              "$url" ) || return 1
            cat /tmp/resp.json
          }

          for repo in "${REPOS[@]}"; do
            owner_repo="$repo"
            repo_name="${repo##*/}"

            # Get Latest Release Info
            if release_resp=$(gh_api "https://api.github.com/repos/$owner_repo/releases/latest"); then
              release_tag=$(echo "$release_resp" | jq -r '.tag_name // empty')
              release_url=$(echo "$release_resp" | jq -r '.html_url // empty')
              release_info="ğŸš€ [${release_tag}](${release_url})"
            else
              release_info="ğŸŒ± No release"
            fi

            # Get Latest Commit
            if commit_resp=$(gh_api "https://api.github.com/repos/$owner_repo/commits?per_page=1"); then
              commit_sha=$(echo "$commit_resp" | jq -r '.[0].sha[0:7] // empty')
              commit_msg=$(echo "$commit_resp" | jq -r '.[0].commit.message' | head -n1 | sed 's/"/\\"/g' || echo "")
              commit_url=$(echo "$commit_resp" | jq -r '.[0].html_url // empty')
              ACTIVITY_MD="${ACTIVITY_MD}- **${repo_name}** â€” ${release_info} Â· ğŸ“ [${commit_msg}](${commit_url}) (\`${commit_sha}\`)\n"
            fi
          done

          # Daily quote (Hitokoto for better CN support)
          quote=$(curl -sS --fail "https://v1.hitokoto.cn/?c=i&c=k" | jq -r '.hitokoto + " â€” " + .from' 2>/dev/null || echo "ä¿æŒå¥½å¥‡ï¼ŒæŒç»­å­¦ä¹ ã€‚")

          echo "activity<<EOF" >> "$GITHUB_OUTPUT"
          printf "%s\n" "${ACTIVITY_MD}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          echo "quote<<EOF" >> "$GITHUB_OUTPUT"
          echo "${quote}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Replace README sections
        run: |
          set -euo pipefail
          activity=$(echo "${{ steps.build_summaries.outputs.activity }}" | sed 's/\\n/\n/g')
          quote="${{ steps.build_summaries.outputs.quote }}"

          awk -v act="$activity" -v q="$quote" '
            BEGIN { in_act=0; in_q=0 }
            // { print; print act; in_act=1; next }
            // { in_act=0; print; next }
            // { print; print ""; print "> " q; in_q=1; next }
            // { in_q=0; print; next }
            { if(!in_act && !in_q) print }
          ' README.md > README.new.md
          mv README.new.md README.md

      - name: Commit and push
        uses: EndBug/add-and-commit@v9
        with:
          message: "chore: automated profile update"
          add: README.md